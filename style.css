// script.js (v2.4 - 修复颜色设置按钮点击问题)
(function () {
  if (document.getElementById('cip-carrot-button')) return;

  // --- 动态加载Emoji Picker库 ---
  const pickerScript = document.createElement('script');
  pickerScript.type = 'module';
  pickerScript.src = 'https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js';
  document.head.appendChild(pickerScript);

  // --- 1. 创建所有UI元素 ---
  function createUI() {
    const create = (tag, id, className, html) => {
      const el = document.createElement(tag);
      if (id) el.id = id;
      if (className) el.className = className;
      if (html) el.innerHTML = html;
      return el;
    };
    const carrotButton = create('div', 'cip-carrot-button', null, '🥕');
    carrotButton.title = '胡萝卜快捷输入';

    const inputPanel = create(
      'div',
      'cip-input-panel',
      'cip-frosted-glass',
      `
            <nav id="cip-panel-tabs">
                <button class="cip-tab-button active" data-tab="text">文字信息</button>
                <button class="cip-tab-button" data-tab="voice">语音</button>
                <button class="cip-tab-button" data-tab="bunny">BUNNY</button>
                <button class="cip-tab-button" data-tab="stickers">表情包</button>
            </nav>
            <div id="cip-format-display"></div>
            <div id="cip-panel-content">
                <div id="cip-text-content" class="cip-content-section">
                    <div class="cip-sub-options-container">
                        <button class="cip-sub-option-btn active" data-type="plain">纯文本</button>
                        <button class="cip-sub-option-btn" data-type="image">图片</button>
                        <button class="cip-sub-option-btn" data-type="video">视频</button>
                        <button class="cip-sub-option-btn" data-type="music">音乐</button>
                        <button class="cip-sub-option-btn" data-type="post">帖子</button>
                    </div>
                    <textarea id="cip-main-input" placeholder="在此输入文字..."></textarea>
                </div>
                <div id="cip-voice-content" class="cip-content-section">
                    <input type="number" id="cip-voice-duration" placeholder="输入时长 (秒, 仅数字)">
                    <textarea id="cip-voice-message" placeholder="输入语音识别出的内容..."></textarea>
                </div>
                <div id="cip-bunny-content" class="cip-content-section">
                    <textarea id="cip-bunny-input" placeholder="在此输入想对BUNNY说的话..."></textarea>
                </div>
                <div id="cip-stickers-content" class="cip-content-section">
                    <div id="cip-sticker-categories" class="cip-sub-options-container">
                        <button id="cip-add-category-btn" class="cip-sub-option-btn">+</button>
                    </div>
                    <div id="cip-sticker-grid"></div>
                </div>
            </div>
            <div id="cip-panel-footer">
                <div style="display: flex; gap: 8px;">
                    <div id="cip-emoji-picker-btn">😊</div>
                    <div id="cip-color-settings-button">👕</div>
                </div>
                <div class="cip-footer-actions">
                    <button id="cip-recall-button">撤回</button>
                    <button id="cip-insert-button">插 入</button>
                </div>
            </div>
        `,
    );

    const emojiPicker = create('emoji-picker', 'cip-emoji-picker', 'cip-frosted-glass');
    const addCategoryModal = create(
      'div',
      'cip-add-category-modal',
      'cip-modal-backdrop hidden',
      `<div class="cip-modal-content cip-frosted-glass"><h3>添加新分类</h3><input type="text" id="cip-new-category-name" placeholder="输入分类名称"><div class="cip-modal-actions"><button id="cip-cancel-category-btn">取消</button><button id="cip-save-category-btn">保存</button></div></div>`,
    );
    const addStickersModal = create(
      'div',
      'cip-add-stickers-modal',
      'cip-modal-backdrop hidden',
      `<div class="cip-modal-content cip-frosted-glass"><h3 id="cip-add-sticker-title"></h3><p>每行一个，格式为：<br><code>表情包描述:图片链接</code></p><textarea id="cip-new-stickers-input" placeholder="可爱猫猫:https://example.com/cat.png\n狗狗点头:https://example.com/dog.gif"></textarea><div class="cip-modal-actions"><button id="cip-cancel-stickers-btn">取消</button><button id="cip-save-stickers-btn">保存</button></div></div>`,
    );
    const colorSettingsPanel = create(
      'div',
      'cip-color-settings-panel',
      'cip-modal-backdrop hidden',
      `
            <div class="cip-color-settings-content cip-frosted-glass">
                <h3>自定义颜色</h3>
                <div class="cip-color-option">
                    <label>面板背景颜色</label>
                    <input type="color" id="cip-color-panel-bg" value="#ffffff">
                </div>
                <div class="cip-color-option">
                    <label>边框颜色</label>
                    <input type="color" id="cip-color-border" value="#ffffff">
                </div>
                <div class="cip-color-option">
                    <label>功能栏字体颜色</label>
                    <input type="color" id="cip-color-text" value="#333333">
                </div>
                <div class="cip-color-option">
                    <label>功能标题颜色</label>
                    <input type="color" id="cip-color-title" value="#333333">
                </div>
                <div class="cip-color-option">
                    <label>功能按钮背景颜色</label>
                    <input type="color" id="cip-color-tabs-bg" value="#ffffff">
                </div>
                <div class="cip-color-option">
                    <label>高亮/按钮颜色</label>
                    <input type="color" id="cip-color-accent" value="#ff7f50">
                </div>
                <div class="cip-color-option">
                    <label>高亮背景颜色</label>
                    <input type="color" id="cip-color-active-bg" value="#ff7f50">
                </div>
                <div class="cip-color-option">
                    <label>输入框背景颜色</label>
                    <input type="color" id="cip-color-input-bg" value="#ffffff">
                </div>
                <div class="cip-color-option">
                    <label>删除按钮颜色</label>
                    <input type="color" id="cip-color-delete" value="#e74c3c">
                </div>
                <div class="cip-color-option">
                    <label>插入按钮字体颜色</label>
                    <input type="color" id="cip-color-insert-text" value Upholding the honor of our family.
