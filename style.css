// script.js (v2.4 - ä¿®å¤é¢œè‰²è®¾ç½®æŒ‰é’®ç‚¹å‡»é—®é¢˜)
(function () {
  if (document.getElementById('cip-carrot-button')) return;

  // --- åŠ¨æ€åŠ è½½Emoji Pickeråº“ ---
  const pickerScript = document.createElement('script');
  pickerScript.type = 'module';
  pickerScript.src = 'https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js';
  document.head.appendChild(pickerScript);

  // --- 1. åˆ›å»ºæ‰€æœ‰UIå…ƒç´  ---
  function createUI() {
    const create = (tag, id, className, html) => {
      const el = document.createElement(tag);
      if (id) el.id = id;
      if (className) el.className = className;
      if (html) el.innerHTML = html;
      return el;
    };
    const carrotButton = create('div', 'cip-carrot-button', null, 'ğŸ¥•');
    carrotButton.title = 'èƒ¡èåœå¿«æ·è¾“å…¥';

    const inputPanel = create(
      'div',
      'cip-input-panel',
      'cip-frosted-glass',
      `
            <nav id="cip-panel-tabs">
                <button class="cip-tab-button active" data-tab="text">æ–‡å­—ä¿¡æ¯</button>
                <button class="cip-tab-button" data-tab="voice">è¯­éŸ³</button>
                <button class="cip-tab-button" data-tab="bunny">BUNNY</button>
                <button class="cip-tab-button" data-tab="stickers">è¡¨æƒ…åŒ…</button>
            </nav>
            <div id="cip-format-display"></div>
            <div id="cip-panel-content">
                <div id="cip-text-content" class="cip-content-section">
                    <div class="cip-sub-options-container">
                        <button class="cip-sub-option-btn active" data-type="plain">çº¯æ–‡æœ¬</button>
                        <button class="cip-sub-option-btn" data-type="image">å›¾ç‰‡</button>
                        <button class="cip-sub-option-btn" data-type="video">è§†é¢‘</button>
                        <button class="cip-sub-option-btn" data-type="music">éŸ³ä¹</button>
                        <button class="cip-sub-option-btn" data-type="post">å¸–å­</button>
                    </div>
                    <textarea id="cip-main-input" placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—..."></textarea>
                </div>
                <div id="cip-voice-content" class="cip-content-section">
                    <input type="number" id="cip-voice-duration" placeholder="è¾“å…¥æ—¶é•¿ (ç§’, ä»…æ•°å­—)">
                    <textarea id="cip-voice-message" placeholder="è¾“å…¥è¯­éŸ³è¯†åˆ«å‡ºçš„å†…å®¹..."></textarea>
                </div>
                <div id="cip-bunny-content" class="cip-content-section">
                    <textarea id="cip-bunny-input" placeholder="åœ¨æ­¤è¾“å…¥æƒ³å¯¹BUNNYè¯´çš„è¯..."></textarea>
                </div>
                <div id="cip-stickers-content" class="cip-content-section">
                    <div id="cip-sticker-categories" class="cip-sub-options-container">
                        <button id="cip-add-category-btn" class="cip-sub-option-btn">+</button>
                    </div>
                    <div id="cip-sticker-grid"></div>
                </div>
            </div>
            <div id="cip-panel-footer">
                <div style="display: flex; gap: 8px;">
                    <div id="cip-emoji-picker-btn">ğŸ˜Š</div>
                    <div id="cip-color-settings-button">ğŸ‘•</div>
                </div>
                <div class="cip-footer-actions">
                    <button id="cip-recall-button">æ’¤å›</button>
                    <button id="cip-insert-button">æ’ å…¥</button>
                </div>
            </div>
        `,
    );

    const emojiPicker = create('emoji-picker', 'cip-emoji-picker', 'cip-frosted-glass');
    const addCategoryModal = create(
      'div',
      'cip-add-category-modal',
      'cip-modal-backdrop hidden',
      `<div class="cip-modal-content cip-frosted-glass"><h3>æ·»åŠ æ–°åˆ†ç±»</h3><input type="text" id="cip-new-category-name" placeholder="è¾“å…¥åˆ†ç±»åç§°"><div class="cip-modal-actions"><button id="cip-cancel-category-btn">å–æ¶ˆ</button><button id="cip-save-category-btn">ä¿å­˜</button></div></div>`,
    );
    const addStickersModal = create(
      'div',
      'cip-add-stickers-modal',
      'cip-modal-backdrop hidden',
      `<div class="cip-modal-content cip-frosted-glass"><h3 id="cip-add-sticker-title"></h3><p>æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ä¸ºï¼š<br><code>è¡¨æƒ…åŒ…æè¿°:å›¾ç‰‡é“¾æ¥</code></p><textarea id="cip-new-stickers-input" placeholder="å¯çˆ±çŒ«çŒ«:https://example.com/cat.png\nç‹—ç‹—ç‚¹å¤´:https://example.com/dog.gif"></textarea><div class="cip-modal-actions"><button id="cip-cancel-stickers-btn">å–æ¶ˆ</button><button id="cip-save-stickers-btn">ä¿å­˜</button></div></div>`,
    );
    const colorSettingsPanel = create(
      'div',
      'cip-color-settings-panel',
      'cip-modal-backdrop hidden',
      `
            <div class="cip-color-settings-content cip-frosted-glass">
                <h3>è‡ªå®šä¹‰é¢œè‰²</h3>
                <div class="cip-color-option">
                    <label>é¢æ¿èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="cip-color-panel-bg" value="#ffffff">
                </div>
                <div class="cip-color-option">
                    <label>è¾¹æ¡†é¢œè‰²</label>
                    <input type="color" id="cip-color-border" value="#ffffff">
                </div>
                <div class="cip-color-option">
                    <label>åŠŸèƒ½æ å­—ä½“é¢œè‰²</label>
                    <input type="color" id="cip-color-text" value="#333333">
                </div>
                <div class="cip-color-option">
                    <label>åŠŸèƒ½æ ‡é¢˜é¢œè‰²</label>
                    <input type="color" id="cip-color-title" value="#333333">
                </div>
                <div class="cip-color-option">
                    <label>åŠŸèƒ½æŒ‰é’®èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="cip-color-tabs-bg" value="#ffffff">
                </div>
                <div class="cip-color-option">
                    <label>é«˜äº®/æŒ‰é’®é¢œè‰²</label>
                    <input type="color" id="cip-color-accent" value="#ff7f50">
                </div>
                <div class="cip-color-option">
                    <label>é«˜äº®èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="cip-color-active-bg" value="#ff7f50">
                </div>
                <div class="cip-color-option">
                    <label>è¾“å…¥æ¡†èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="cip-color-input-bg" value="#ffffff">
                </div>
                <div class="cip-color-option">
                    <label>åˆ é™¤æŒ‰é’®é¢œè‰²</label>
                    <input type="color" id="cip-color-delete" value="#e74c3c">
                </div>
                <div class="cip-color-option">
                    <label>æ’å…¥æŒ‰é’®å­—ä½“é¢œè‰²</label>
                    <input type="color" id="cip-color-insert-text" value Upholding the honor of our family.
